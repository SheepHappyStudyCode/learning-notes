# RocketMQ

## 什么场景下使用

金融交易、订单交易场景

## 事务消息

事务消息是 RocketMQ 提供的一种高级消息类型，支持在分布式场景下保障消息生产和本地事务的**最终一致性**。

### 特点

事务消息能够像事务一样回滚，从而保证本地事务提交后消息一定能够发送出去

### 正常执行流程

1. 执行事务前，生产者向 MQ 发送一条事务消息，MQ 持久化成功后向消费者发送 ack，此时消息被标记为”不可投递“状态。
2. 生产者执行本地事务，执行完成会给 MQ 发送确认消息，如果事务执行成功 MQ 会投递消息给消费者，否则取消这条事务消息。

### 异常执行情况

1. 消费者发送半消息，没有收到 ACK。

   这时候不会执行本地事务

2. 消费者执行完本地事务后，发送给 mq 的确认消息丢失。

   MQ 在长时间没有收到确认消息后会回调生产者的接口，从而得知本地事务的执行结果

3. 消费者执行完本地事务后，向 MQ 发送确认消息但此时 MQ 宕机

   因为 MQ 持久化过事务消息，所以重启后能够回调消费者，从而得知本地事务的执行结果，决定消息是否投递。

### 总结

事务消息能够将事务的执行和投递消息变为一个原子操作，从而实现分布式事务。

## 顺序消费



