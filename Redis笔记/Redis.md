﻿﻿﻿﻿# Redis
## 1 Redis入门知识
1. Redis简介：远程词典服务器，是一种**基于内存**的**键值型**NoSQL数据库。
2. NoSQL数据库：非关系型数据库。
	- 特点：
		- 非结构化
		- 无关联的
		- 非SQL
		- BASE（不满足ACID的事务特性）
		- 数据存放在内存中
		- 具有水平扩展性

	- 使用场景：
		- 数据结构不固定
		- 对一致性、安全性要求不高
		- 对性能要求高

## 2 常用数据结构

### String

最基本的数据类型，本质是一个字节数组，可以存放普通字符串，也可以存放数字。

### List

双向链表

### Hash

一个键值对集合

### Set

没有顺序的哈希表

### Zset

相比于 Set 多了一个 score 字段，常用于实现实时排行榜功能

### Bitmap

位数组，可以用于保存大量简单的状态，例如用户的连续登录天数，每天的用户登录数量

### HyperLogLog

可以用来估算大规模数据集的基数，它只关心不同元素的数量，而不是元素的具体值，需要耗费的内存一定，估算的偏差也在一定范围。

### Geospatial
记录和处理地理信息



## 3 Redis 的事务操作
1. 事务的作用：串联多个命令，防止其他命令插队。
2. 事务命令：
	- `Multi`：组队阶段，输入的命令都进入命令序列，但不会执行。
	- `Exec`：执行命令
	- `discard`：放弃组队
3. 错误处理：
	- 组队阶段出现错误：全部命令都不会执行
	- 执行阶段出现错误：错误命令不会执行，其他命令都执行



## 4 Redis持久化

### RDB 持久化

在指定的**时间间隔**内将内存中的数据集**快照**写入磁盘。

**优点：**

从 RDB 文件恢复数据的速度很快

**缺点：**

两次保存数据库快照的时间间隔较长，如果宕机容易发生数据丢失

### AOF 持久化

以**日志**的形式记录每个写操作（增量保存）。

**优点：**

默认是每秒写入日志一次，数据的安全性高，不容易发生丢失

**缺点：**

从 AOF 文件恢复数据的速度比 RDB 慢，AOF 文件的大小通常也比 RDB 大。（不过 AOF 文件到达一定阈值会触发重写）

#### AOF 文件的重写

AOF 重写是一个后台操作，不会阻塞 Redis 服务，它会通过 **fork 创建一个子进程**，子进程会读取 Redis 的 **内存数据** 写到一个临时文件中，最后替换掉原来的文件。

p.s. AOF 文件重写期间的命令会被主节点写到缓冲区里，重写完成后主节点会将这些命令写入新的 AOF 文件。

## 5 Redis的主从复制
### 5.1 简介
主服务器数据更新后根据配置和策略，自动同步到备用机的 master/slave 机制，**master以写为主，slave以读为主。**
### 5.2 作用
1. 数据备份
1. 读写分离
2. 容灾快速恢复（配合 Redis 哨兵模式能够完成故障自动转移）
### 5.3 相关命令
1. 查看主从信息：`info replication`
2. 配置主从信息：`slaveof <host> <port>` 
3. 从机替代主机：`slaveof no one`
### 5.4 哨兵模式 sentinel
1. 简介：常配合主从复制的 Redis 节点使用，可以实现**自动故障转移**。
2. 替换规则：
	- 要设置至少一个哨兵监视主机。
	- 优先级高的从机优先替换。
	- 从机替换主机后，原来的主机重启后会成为从机。
## 6 Redis集群
1. 简介：Redis集群将Redis进行**水平扩容**，即启动N个Redis节点，将整个数据库分布存储在这N个节点中。一般采用**无中心化**集群。
2. 集群化配置：
``` 
cluster-enabled yes
cluster-config-file nodes-6379.conf
cluster-node-timeout 15000
```
3. 相关命令：
	- 查看集群信息：`cluster nodes`
	- 查看键的插槽值：`cluster keyslot <key>`
	- 计算插槽值里有几个键：`cluster countkeysinslot <插槽值>`
	- 得到插槽中的键：`cluster getkeysinslot <插槽值>`
4. 集群分配原则：
	- 集群至少有**三个主节点**
	- 尽量保证每个主数据库运行在**不同的IP地址**，每个从库和主库不在同一个IP地址上。
5. 优点：
	- 实现扩容
	- 分摊压力
	- 无中心配置相对简单
6. 缺点：
	- 多键操作不被支持
	- 多建的Redis事务不被支持。lua脚本不支持
	- 很多公司的采用其他的集群方案，迁移困难
## 7 Redis应用问题解决
### 7.1 缓存穿透
1. 问题描述：很多请求**查询数据库不存在的数据**，缓存对这类请求没有效果，导致直接查询数据库，导致数据库压力激增。
2. 解决方法：
	1. **缓存一些空值**，设置较短的过期时间
	2. 设置白名单
	3. 采用**布隆过滤器**，提前判断一些数据存不存在，不存在直接返回。
	4. 进行实时监控
### 7.2 缓存雪崩

1. 问题描述：大量 key 几乎同时失效，导致大量请求同时查询数据库。
2. 解决方案：
   - 如果是大量 key 同时失效导致的缓存雪崩，可以设置 key 的**过期时间随机化**
   - 如果是 Redis 宕机导致的缓存雪崩，可以构建集群保证 Redis 的高可用。

### 7.3 缓存击穿
1. 问题描述：一些**热点 key** 在较短时间内同时过期，导致大量并发请求查询数据库。
2. 解决方案：
	- **互斥锁**：只允许一个线程查询数据库，这个线程会进行缓存重建，其他线程就去查缓存。
	- **预先设置热门数据**，延长热门数据key的时长，甚至**永不过期**。
	- 热点 key 的过期时间随机化。
### 7.4 分布式锁
1. Redia实现分布式锁：通过`setnx`插入键值对，只有`del`这个键值对后才能再次赋值。同时要对这个键值对设置过期时间，避免锁长时间不释放。
2. 误删锁问题的解决方案：
	- 拿到锁时设置一个唯一标识，删除前判断该标识是否发生变化，如果是自己的标识才释放锁。（避免释放别人的锁）
	- 使用Lua脚本实现原子性操作
## 11 Redis新功能
### 11.1 ACL
1. ACL：权限控制列表
2. 相关命令：
	- `acl list`
	- `acl cat`
	- `acl setuser <username>`
	- `acl whoami`
### 11.2 IO多线程
1. 虽然支持多线程，但执行命令的方式还是单线程。

### 11.3 工具支持Cluster



## 12 Redis客户端的常见命令

1. [springboot使用redis（StringRedisTemplate的用法）-CSDN博客](https://blog.csdn.net/weixin_43835717/article/details/92802040)

2. [在 Spring Boot 中整合、使用 Redis - spring 中文网 (springdoc.cn)](https://springdoc.cn/spring-boot-data-redis/)

3. [redisson使用全解——redisson官方文档+注释（上篇）_redisson官网中文-CSDN博客](https://blog.csdn.net/A_art_xiang/article/details/125525864)

4. [【进阶篇】Redis实战之Redisson使用技巧详解，干活！-腾讯云开发者社区-腾讯云 (tencent.com)](https://cloud.tencent.com/developer/article/2223087)



