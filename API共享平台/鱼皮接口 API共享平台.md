# API共享平台

## 背景

前端开发需要用到后端接口



## 做一个API接口平台的注意点：

1. 防止攻击（安全性）
2. 不能随便调用（限制、开通）
3. **统计调用次数**
4. 计费
5. 流量保护
6. API接入



## 项目介绍

做一个提供**API接口调用**的平台，**用户**可以注册登录，开通接口调用权限。用户可以使用接口，并且每次调用会进行统计。**管理员**可以发布接口、下线接口、接入接口，以及可视化接口的调用情况、数据



## 业务流程

1. 后台管理系统
2. 用户前台

3. API 网关



## 技术栈

### 后端

Java Spring Boot

Spring Boot Starter（SDK开发）

网关实现



## 需求分析

1. 管理员可以增删改查接口
2. 用户可以访问前台，查看接口信息



## 库表设计

### 接口信息表

id

name 接口名称

descriptiono 接口描述

url 接口地址

method 请求类型

requestHeader 请求头   类型：text

responseHeader 响应头

status 接口状态 0 - 关闭   1 - 开启

userId 创建人信息



isDelete

createTime

updateTime



## 模拟接口项目 yuapi-interface

提供三个模拟接口：

1. get
2. post：url传参
3. post：restful



## 调用接口

hutool



## API 签名认证
本质
1. 签发签名
2. 使用签名（校验签名）

为什么需要：
1. 保证安全性，不能让一个人随便调用

### 实现方法

​	accessKey：调用的标识 userA, userB

​	secretKey：密钥

流程：服务端将accessKey和secretKey返回给客户端，客户端将参数和密钥通过非对称加密算法生成密文，将密文发送给服务器，服务器若能以同样的算法生成同样的密文，该用户身份正确。

### 怎么防止重放

请求时加 nonce 随机数和时间戳





## 如何写SDK

1. 引入spring-boot-configuration-processor和spring-boot-autoconfigure依赖
2. 将pom文件里的build去掉
3. 编写配置类（启动类）
4. 注册配置类，resources/META-INF/spring.factories文件



## 统计用户调用接口的次数

### 库表设计

user_interface_info表

id

user_id

interfaceInfoId

totalNum 总的调用次数

leftNum 剩余的调用次数

status 接口状态 0 - 正常  1 - 禁用

...

## 业务实现

在每个接口调用后，通过 userId 和 interfaceInfoId 找到对应的记录，使其 totalNum++， leftNum-- 





## API 网关

可以理解为火车站的检票口，统一去检票。

网关的优点：统一进行一些操作



### 网关的应用

#### 1 路由

起到转发的功能，比如有接口A和接口B，网关会记录这些信息，根据用户访问的地址和参数，转发请求到对应的接口

#### 2 负载均衡

在路由功能的基础上，可以实现负载均衡

#### 3 鉴权

#### 4 跨域

在网关统一处理跨域，不用在每个项目单独处理

#### 5 统一业务处理

把某些每个项目通用的功能放在网关处理，比如某个接口的次数统计

#### 6 访问控制

访问黑白名单，比如限制 ip

#### 7 发布控制

灰度测试。已有接口A，想要写一个接口B替换接口A，但不确定接口B是否能正确工作，于是先让网关将部分流量导向接口B，如果接口B运行一段时间没有问题，就用接口B完全替代接口A。

#### 8 流量染色

给请求（流量）添加标识，一般设置在请求头中。

#### 9 统一接口保护

1. 限制请求

2. 信息脱敏

3. 降级

4. 限流

5. 超时时间

#### 10 统一日志、统一文档



## 网关的分类

1. 业务网关（接入层网关）
2. 全局网关（接入层网关）



## 实现

1. Nginx、Kong网关（API网关）
2. **Spring Cloud Gateway**（取代了zuul），性能高，可以用Java代码写逻辑。



## Spring Cloud Gateway 的使用

### 核心概念

路由（根据什么条件，转发请求到哪里）

断言（一组规则、条件，用来确定如何转发路由）

过滤器：对请求做一些处理，比如统一添加请求头

### 两种配置方式

1. 配置式：方便、规范
  - 简化版
  - 全称版

1. 编程式：灵活、自由

### 断言

1. After：在xxx时间之后
2. Before
3. Between
4. 请求类别
5. 请求头（是否携带cookie）
6. 查询参数
7. 权重

### 过滤器

1. 添加请求头
2. 添加请求参数
3. 添加响应头
4. 接口降级：一个接口地址访问不通时，重定向到另一个接口

5. 限流



## API平台使用的网关功能

1. 路由：转发请求到模拟接口项目
2. 鉴权：通过ak，sk鉴权



## 统计接口调用次数的业务逻辑

1. 打印日志
2. 查看ip是否在白名单，不在就设置response为403，调用setComplete()方法
3. 用户鉴权（判断ak，sk是否合法，判断时间戳是否过期）
4. 请求的模拟接口是否存在
5. 请求转发，调用模拟接口
6. 调用成功，调用次数+1
7. 调用失败，返回一个规范的错误码



## 怎么调用其他项目的方法

1. 复制代码和环境
2. http
3. 打个jar包
4. **RPC**



## RPC

**作用：像调用本地方法一样调用远程方法**

优点：

	1. 对开发者更透明，减少了很多沟通成本
	1. 不一定要使用http协议。还可以使用其他的协议





## Java整合Dubbo

1. 引入dubbo和注册中心的相关依赖
2. 编写相应的配置
3. 启动类加上`@EnableDubbo`注解
4. 引入公共服务模块



## 公共服务模块

主要由公共的服务接口和实体类组成
